{% extends "base.html" %}
{% load sample_filters %}
{% block title %}Participant Details{% endblock %}
{% block breadcrumbs_items %}
    <ul>
        <li><a href="/studyparticipants">Participants</a></li>
        <li>&nbsp;&gt;&nbsp;</li>
        <li>Participant</li>
    </ul>
{% endblock %}
{% block content %}
    <div class="container">
        <div class="well col-md-12">
            <h3>{{ participant|force_escape }}</h3>
            <div class="fixed-action-btn">
                <a class="btn-floating btn-large green" title="Edit Participant"
                   href="{% url 'participant_update' participant.id %}">
                    <i class="material-icons">edit</i>
                </a>
                <a class="btn-floating btn-large red" title="Delete Participant"
                   href="{% url 'participant_delete' participant.id %}">
                    <i class="large material-icons">delete</i>
                </a>
            </div>
        </div>
        <div id="error"> {{ error }}</div>
        <div id="panel-group" class="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" href="#collapse1">General Information</a>

                    </h3>

                </div>
                <div id="collapse1" class="collapse" data-parent="#panel-group">
                    <div class="panel-body">
                        <table class="table table-condensed">
                            <tbody>
                            <tr>
                                <th>ID:</th>
                                <td>{{ participant.id }}</td>
                            </tr>
                            <tr>
                                <th>Country:</th>
                                <td>{{ participant.get_country_display }}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>{{ participant.get_status_display }}</td>
                            </tr>
                            <tr>
                                <th>Alpha code:</th>
                                <td>{{ participant.alphacode }}</td>
                            </tr>
                            <tr>
                                <th>Secondary ID:</th>
                                <td>{{ participant.secondaryid }}</td>
                            </tr>
                            <tr>
                                <th>NP ID:</th>
                                <td>{{ participant.npid }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="panel-footer"></div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" href="#collapse2">Studies</a>
                        <div class="fixed-action-btn">
                            <a class="btn-floating blue-grey small" title="Add Study"
                               href="{% url 'study_participant_create' participant.id %}">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </h3>
                </div>
                <div id="collapse2" class="collapse" data-parent="#panel-group">
                    <div class="panel-body">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Participant No</th>
                                <th>Family Code</th>
                                <th>Individual Code</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for pstudy in participant.studyparticipants.all %}
                                <tr>
                                    <td>{{ pstudy.study.title }}</td>
                                    <td>{{ pstudy.study.get_status_display }}</td>
                                    <td>{{ pstudy.getFullNumber }}</td>
                                    <td>{{ pstudy.family }}</td>
                                    <td>{{ pstudy.individual }}</td>
                                    <td><a class="btn-floating green small" title="Edit Study Participant"
                                           href="{% url 'study_participant_update' pstudy.id %}">
                                        <i class="material-icons">edit</i>
                                    </a></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="panel-footer"></div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" href="#collapse5">Clinical Records</a>
                    </h3>

                </div>
                <div id="collapse5" class="collapse" data-parent="#panel-group">
                    <div class="panel-body">
                        <table class="table table-condensed">
                            <tbody>
                            <tr>
                                <th>ID</th>
                                <th>Gender</th>
                                <th>Diagnosis</th>
                                <th>Age at Assessment</th>
                                <th>Symptoms Onset</th>
                                <th>Severity Pattern</th>
                                <th>Actions</th>
                            </tr>
                            {% for p in participant.studyparticipants.all %}
                                <tr>
                                    {% if p.clinical.count == 0 %}
                                        <td>{{ p.getFullNumber }}</td>
                                        <td colspan="5">
                                            No clinical record
                                        </td>
                                        <td><a class="btn-floating blue-grey small" title="Add Clinical Record"
                                               href="{% url 'clinical_participant_create' p.id %}">
                                            <i class="material-icons">add</i>
                                        </a></td>
                                    {% endif %}
                                </tr>
                                {% for clinical in p.clinical.all %}
                                    <tr>
                                        <td>{{ p.getFullNumber }}</td>
                                        <td>{{ clinical.demographic.get_gender_display }}</td>
                                        <td>{{ clinical.diagnosis.summary }}</td>
                                        <td>{{ clinical.demographic.age_assessment }}</td>
                                        <td>{{ clinical.symptoms_general.get_onset_display }}</td>
                                        <td>{{ clinical.symptoms_general.get_severity_pattern_display }}</td>
                                        <td><a class="btn-floating green small" title="View Clinical Record"
                                               href="{% url 'clinical_detail' clinical.id %}">
                                            <i class="material-icons">visibility</i>
                                        </a></td>
                                    </tr>
                                {% endfor %}


                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="panel-footer"></div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" href="#collapse4">Samples</a>
                        <div class="fixed-action-btn">
                            <a class="btn-floating blue-grey small" title="Add Sample"
                               href="{% url 'sample_participant_create' participant.id %}">
                                <i class="material-icons">add</i>
                            </a>
                        </div>
                    </h3>
                </div>
                <div id="collapse4" class="collapse" data-parent="#panel-group">
                    <div class="panel-body">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Sample</th>
                                <th>Date</th>
                                <th>Rebleed</th>
                                <th>Transform</th>
                                <th>Harvest</th>
                                <th>Shipment</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for ps in participant.studyparticipants.all %}
                                {% for sample in ps.sample_set.all %}
                                    <tr>
                                        <td>{{ sample.get_sample_type_display }}</td>
                                        <td>{{ sample.arrival_date }}</td>
                                        <td>{{ sample.rebleed|yesno }}</td>
                                        <td>
                                            <ul>
                                                {% for transform in sample.transformsample_set.all %}
                                                    <li>{{ transform.transform_date }}
                                                        - {{ transform.failed|failpass }}</li>
                                                {% endfor %}
                                            </ul>
                                        </td>
                                        <td>
                                            <ul>
                                                {% for harvest in sample.harvestsample_set.all %}
                                                    <li>Regrow: {{ harvest.regrow_date }}
                                                        Harvest: {{ harvest.harvest_date }}
                                                        - {{ harvest.notes }}</li>
                                                {% endfor %}
                                            </ul>
                                        </td>
                                        <td>
                                            <ul>
                                                {% for ship in sample.shipmentsample_set.all %}
                                                    <li>Rutgers: {{ ship.rutgers_number }}
                                                        Date: {{ ship.shipment_date }}
                                                        - {{ ship.notes }}</li>
                                                {% endfor %}
                                            </ul>
                                        </td>
                                        <td>{{ sample.notes }}</td>
                                        <td><a class="btn-floating grey small" title="View Sample"
                                               href="{% url 'sample_detail' sample.id %}">
                                            <i class="material-icons">visibility</i>
                                        </a></td>
                                    </tr>
                                {% endfor %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="panel-footer"></div>
                </div>

            </div>
        </div>

        {% for type, val in subsampletypes %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" href="#subpanel{{ forloop.counter0 }}">{{ val }}s</a>
                    </h3>
                </div>
                <div id="subpanel{{ forloop.counter0 }}" class="collapse" data-parent="#panel-group">
                    <div class="panel-body">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Sample Arrival</th>
                                <th>Num</th>
                                <th>Storage date</th>
                                <th>Location</th>
                                <th>Used</th>
                                <th>Used date</th>
                                {% if type == 'DNA' %}
                                    <th>Extraction date</th>
                                {% endif %}
                                <th>QC</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for ps in participant.studyparticipants.all %}
                                {% for sample in ps.sample_set.all %}
                                    {% for subsample in sample.subsample_set|filtersamples:type %}
                                        <tr>
                                            <td>{{ sample.arrival_date }}</td>
                                            <td>{{ subsample.sample_num }}</td>
                                            <td>{{ subsample.storage_date }}</td>
                                            <td>{{ subsample.location }}</td>
                                            <td>{{ subsample.used|yesno }}</td>
                                            <td>{{ subsample.used_date }}</td>
                                            {% if type == 'DNA' %}
                                                <td>{{ subsample.extraction_date }}</td>
                                            {% endif %}
                                            <td>{% if subsample.get_qc_result %}
                                                {{ subsample.get_qc_result.passed|passfail }}
                                            {% endif %}</td>
                                            <td>{{ subsample.notes }}</td>
                                            <td><a class="btn-floating green small" title="Edit SubSample"
                                                   href="{% url 'subsample_update' subsample.id %}">
                                                <i class="material-icons">edit</i>
                                            </a></td>
                                        </tr>
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="panel-footer"></div>
                </div>

            </div>
        {% endfor %}

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <a data-toggle="collapse" href="#collapse3">Datasets</a>
                    <div class="fixed-action-btn">
                        <a class="btn-floating blue-grey small" title="Select Dataset"
                           href="{% url 'datasets' %}">
                            <i class="material-icons">add</i>
                        </a>
                    </div>
                </h3>
            </div>
            <div id="collapse3" class="collapse" data-parent="#panel-group">
                <div class="panel-body">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Dataset</th>
                            <th>DIGS</th>
                            <th>FIGS</th>
                            <th>Narrative</th>
                            <th>Records</th>
                            <th>Consensus</th>
                            <th>LDPS</th>
                            <th>Notes</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for ps in participant.studyparticipants.all %}
                            {% for dataset in ps.datasetrow_set.all %}
                                <tr>
                                    <td>{{ dataset.dataset.group }}</td>
                                    <td>{{ dataset.get_digs_display }}</td>
                                    <td>{{ dataset.get_figs_display }}</td>
                                    <td>{{ dataset.get_narrative_display }}</td>
                                    <td>{{ dataset.get_records_display }}</td>
                                    <td>{{ dataset.get_consensus_display }}</td>
                                    <td>{{ dataset.get_ldps_display }}</td>
                                    <td>{{ dataset.notes }}</td>
                                    <td>
                                        <a class="btn-floating blue-grey small" title="Add Dataset for Participant"
                                           href="{% url 'dataset_participant_create' dataset.dataset.id participant.id %}">
                                            <i class="material-icons">add</i>
                                        </a>
                                        <a class="btn-floating green small" title="Edit Dataset"
                                           href="{% url 'dataset_participant_update' dataset.id %}">
                                            <i class="material-icons">edit</i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="panel-footer"></div>
            </div>
        </div>

    </div>

    </div>

{% endblock %}